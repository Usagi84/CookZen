# Projet : Google Pay + Braintree (sans Stripe)

Ce projet montre comment encaisser avec **Google Pay** via **Braintree (PayPal)**, sans Stripe.

---

## Fichiers

### 1) `public/index.html`
```html
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paiement Google Pay via Braintree</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:40px}
    .wrap{max-width:720px;margin:auto}
    #gpay-btn{margin-top:16px}
    .log{white-space:pre-wrap;background:#111;color:#eee;padding:12px;border-radius:8px;margin-top:16px}
    .ok{color:#0a0}
    .err{color:#d22}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Google Pay via Braintree</h1>
  <p>Total: <strong>$0.99</strong> (USD)</p>
  <div id="gpay-btn"></div>
  <div id="out" class="log"></div>
</div>

<!-- Google Pay JS -->
<script async src="https://pay.google.com/gp/p/js/pay.js" onload="init()"></script>
<!-- Braintree Web SDK (client + google-payment) -->
<script src="https://js.braintreegateway.com/web/3.127.0/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.127.0/js/google-payment.min.js"></script>
<script>
  const AMOUNT = "0.99";            // Montant (string)
  const CURRENCY = "USD";           // Devise
  const COUNTRY_CODE = "US";        // Code pays pour Google Pay
  const ENV = "TEST";               // TEST ou PRODUCTION (Google Pay)
  const MERCHANT_ID = "REPLACE_WITH_GOOGLE_MERCHANT_ID"; // requis en production

  const out = (m, cls="") => {
    const el = document.getElementById('out');
    el.innerHTML += `\n${m}`;
    if (cls) el.className = `log ${cls}`;
  };

  async function init(){
    try {
      // 1) Récupérer un clientToken depuis le serveur
      const res = await fetch('/client-token');
      const { clientToken } = await res.json();
      if(!clientToken) throw new Error('Pas de clientToken');

      // 2) Créer le client Braintree
      const clientInstance = await braintree.client.create({ authorization: clientToken });

      // 3) Créer l'instance Google Payment côté Braintree
      const googlePaymentInstance = await braintree.googlePayment.create({
        client: clientInstance,
        googlePayVersion: 2,
        googleMerchantId: MERCHANT_ID // requis en PROD
      });

      // 4) Construire la requête Google Pay v2 via Braintree
      const paymentDataRequest = googlePaymentInstance.createPaymentDataRequest({
        transactionInfo: {
          countryCode: COUNTRY_CODE,
          currencyCode: CURRENCY,
          totalPriceStatus: 'FINAL',
          totalPrice: AMOUNT
        },
        // Vous pouvez préciser des contraintes carte si besoin
        // allowedPaymentMethods est rempli par Braintree
      });

      // 5) Créer le client Google Pay
      const paymentsClient = new google.payments.api.PaymentsClient({ environment: ENV });

      // 6) Vérifier si l'appareil peut payer
      const isReady = await paymentsClient.isReadyToPay({
        allowedPaymentMethods: paymentDataRequest.allowedPaymentMethods,
        existingPaymentMethodRequired: false
      });

      if (isReady.result) {
        // 7) Afficher le bouton Google Pay
        const button = paymentsClient.createButton({
          onClick: () => onPayClicked(paymentsClient, paymentDataRequest, googlePaymentInstance),
        });
        document.getElementById('gpay-btn').appendChild(button);
        out('Bouton Google Pay prêt.');
      } else {
        out('Google Pay non disponible.', 'err');
      }
    } catch (e){
      console.error(e);
      out(`Erreur init: ${e.message}`, 'err');
    }
  }

  async function onPayClicked(paymentsClient, paymentDataRequest, googlePaymentInstance){
    try {
      // 8) Ouvrir la sheet Google Pay
      const paymentData = await paymentsClient.loadPaymentData(paymentDataRequest);

      // 9) Parser la réponse via Braintree pour obtenir un NONCE (pas un token brut)
      const payload = await googlePaymentInstance.parseResponse(paymentData);
      const nonce = payload.nonce; // <- à envoyer au serveur
      out('Nonce reçu: ' + nonce.substring(0, 10) + '...');

      // 10) Appeler le serveur pour créer la transaction
      const res = await fetch('/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: AMOUNT, paymentMethodNonce: nonce })
      });
      const data = await res.json();
      if (data.success) {
        out('Paiement réussi ✅\nTransaction ID: ' + data.transaction.id, 'ok');
      } else {
        out('Paiement échoué ❌\n' + (data.error || 'Erreur inconnue'), 'err');
      }
    } catch (e){
      console.error(e);
      out('Erreur paiement: ' + e.message, 'err');
    }
  }
</script>
</body>
</html>
```

---

### 2) `server.js`
```js
// Backend Node.js + Express + Braintree
// 1) npm init -y
// 2) npm install express braintree cors
// 3) node server.js

const express = require('express');
const cors = require('cors');
const braintree = require('braintree');

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static('public')); // sert index.html

// ⚠️ Remplacez par vos identifiants sandbox/production Braintree
const gateway = new braintree.BraintreeGateway({
  environment: braintree.Environment.Sandbox, // ou Production
  merchantId: process.env.BT_MERCHANT_ID || 'your_merchant_id',
  publicKey:  process.env.BT_PUBLIC_KEY  || 'your_public_key',
  privateKey: process.env.BT_PRIVATE_KEY || 'your_private_key',
});

// 1) Fournir un clientToken au front
app.get('/client-token', async (req, res) => {
  try {
    const { clientToken } = await gateway.clientToken.generate({});
    res.json({ clientToken });
  } catch (e){
    console.error('client-token error', e);
    res.status(500).json({ error: e.message });
  }
});

// 2) Créer la transaction avec le paymentMethodNonce renvoyé par Google Pay via Braintree
app.post('/checkout', async (req, res) => {
  try {
    const { amount, paymentMethodNonce } = req.body;
    if(!amount || !paymentMethodNonce){
      return res.status(400).json({ success: false, error: 'amount et paymentMethodNonce requis' });
    }

    const saleRequest = {
      amount: amount,
      paymentMethodNonce: paymentMethodNonce,
      options: { submitForSettlement: true }, // capture immédiate
    };

    const result = await gateway.transaction.sale(saleRequest);

    if (result.success) {
      return res.json({ success: true, transaction: result.transaction });
    } else {
      const message = (result.message || 'Transaction échouée');
      return res.status(402).json({ success: false, error: message });
    }
  } catch (e){
    console.error('checkout error', e);
    res.status(500).json({ success: false, error: e.message });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`✅ Serveur sur http://localhost:${PORT}`));
```

---

### 3) `package.json`
```json
{
  "name": "gpay-braintree-demo",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "braintree": "^1.53.0",
    "cors": "^2.8.5",
    "express": "^4.19.2"
  }
}
```

---

## Notes importantes (PRODUCTION)
- Remplacez `ENV = "TEST"` par `"PRODUCTION"` côté front, et renseignez **`googleMerchantId`** (fourni par Google) dans `braintree.googlePayment.create`.
- Activez **Google Pay** dans votre **Braintree Control Panel** et utilisez vos clés **Production**.
- Définissez les variables d’env : `BT_MERCHANT_ID`, `BT_PUBLIC_KEY`, `BT_PRIVATE_KEY`.
- Servez la page en **HTTPS** (obligatoire pour Google Pay).
- Pour les montants, utilisez les devises et pays autorisés par Braintree + Google Pay.
